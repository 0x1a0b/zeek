# Checks logging of mime types and md5 calculation.  Mime type in the log
# is normalized to prevent sensitivity to libmagic version.

# @TEST-REQUIRES: grep -q '#define HAVE_LIBMAGIC' $BUILD/config.h
# @TEST-EXEC: bro -r $TRACES/smtp.trace %INPUT
# @TEST-EXEC: btest-diff smtp_mime.log

@load protocols/smtp/base/main
@load protocols/smtp/base/mime

redef SMTP::generate_md5=/text\/plain/;

event bro_init()
	{
	Log::remove_default_filter(SMTP::SMTP_MIME);
	Log::add_filter(SMTP::SMTP_MIME, [$name="normalized-mime-types",
									  $pred=function(rec: SMTP::MimeInfo): bool
		{
		if ( rec?$mime_type )
			rec$mime_type = "FAKE_MIME";
		return T;
		}
	]);
	}
